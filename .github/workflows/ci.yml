name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - master

jobs:
  pigeon_contracts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
      - run: dart run melos bootstrap
      - run: dart run pigeon --input pigeons/midi_api.dart
      - run: git diff --exit-code -- packages/flutter_midi_command_platform_interface/lib/src/pigeon packages/flutter_midi_command_android/android/src/main/kotlin/com/invisiblewrench/fluttermidicommand/pigeon packages/flutter_midi_command_darwin/ios/Classes/pigeon

  dart_checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
      - run: dart pub global activate melos
      - run: melos bootstrap
      - name: Android native unit tests
        run: ./gradlew :flutter_midi_command_android:testDebugUnitTest
        working-directory: example/android
      - run: melos run analyze
      - run: melos run test

  build_example_android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
      - run: dart pub global activate melos
      - run: melos bootstrap
      - run: melos run build:example:android

  build_example_linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
      - run: dart pub global activate melos
      - run: melos bootstrap
      - run: melos run build:example:linux

  build_example_ios_macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
      - run: dart pub global activate melos
      - run: melos bootstrap
      - name: Darwin native parser smoke test
        run: |
          swiftc packages/flutter_midi_command_darwin/ios/Classes/MidiPacketParser.swift \
                 packages/flutter_midi_command_darwin/ios/Tests/midi_packet_parser_smoke.swift \
                 -o /tmp/midi_packet_parser_smoke
          /tmp/midi_packet_parser_smoke
      - run: melos run build:example:ios
      - run: melos run build:example:macos

  build_example_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
      - run: dart pub global activate melos
      - run: melos bootstrap
      - run: melos run build:example:windows
